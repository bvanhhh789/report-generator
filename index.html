<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Báo Cáo Hoạt Động</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        body { background-color: #f0f2f5; padding: 30px 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 15px; }
        .card-header { border-radius: 15px 15px 0 0 !important; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .form-label { font-weight: 600; color: #495057; font-size: 0.9rem; }
        .section-title { border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-bottom: 20px; color: #0d6efd; font-weight: bold; }
        
        /* Style cho dòng công việc */
        .task-row { background: #fff; border: 1px solid #dee2e6; border-left: 4px solid #0d6efd; padding: 15px; border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; position: relative; }
        .task-row:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* Style cho nút xóa */
        .btn-delete-row { color: #dc3545; cursor: pointer; transition: 0.2s; }
        .btn-delete-row:hover { color: #bb2d3b; transform: scale(1.1); }
        /* Ẩn nút xóa khi bị disable */
        .btn-delete-row.disabled { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white py-3 text-center">
                    <i class="bi bi-file-earmark-text me-2"></i>Nhập liệu Báo cáo Hoạt động
                </div>
                <div class="card-body p-4">
                    <form id="reportForm">
                        
                        <h5 class="section-title"><i class="bi bi-person-badge me-2"></i>I. Thông tin chung</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Ngày báo cáo (*)</label>
                                <input type="text" class="form-control bg-white" id="inputDate" placeholder="dd/mm/yyyy" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Họ và tên (*)</label>
                                <input type="text" class="form-control" id="hoVaTen" placeholder="Nguyễn Văn A" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Chức vụ</label>
                                <input type="text" class="form-control" id="chucVu" placeholder="Trưởng nhóm">
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="sdt" placeholder="09xxxxxxx">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Tên hoạt động (*)</label>
                                <input type="text" class="form-control" id="tenHoatDong" placeholder="Triển khai dự án X" required>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Thời gian diễn ra (Nhập tay)</label>
                                <input type="text" class="form-control" id="thoiGianHD" placeholder="Ví dụ: 8h00 - 17h00">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Địa điểm</label>
                                <input type="text" class="form-control" id="diaDiemHD" placeholder="Phòng họp số 1">
                            </div>
                        </div>

                        <h5 class="section-title"><i class="bi bi-list-task me-2"></i>II. Danh sách công việc</h5>
                        <div id="taskList">
                            </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addTaskRow()">
                            <i class="bi bi-plus-circle me-1"></i>Thêm dòng công việc
                        </button>

                        <h5 class="section-title mt-4"><i class="bi bi-chat-left-text me-2"></i>III. Ý kiến đóng góp</h5>
                        <div class="mb-3">
                            <label class="form-label">Khó khăn, vướng mắc (Nếu có)</label>
                            <textarea class="form-control" id="khoKhan" rows="3" placeholder="Để trống nếu không có (Hệ thống sẽ tự điền dòng kẻ chấm)"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Đề xuất, kiến nghị</label>
                            <textarea class="form-control" id="deXuat" rows="3" placeholder="Đề xuất giải pháp..."></textarea>
                        </div>

                        <h5 class="section-title mt-4"><i class="bi bi-check2-square me-2"></i>IV. Tự đánh giá cá nhân</h5>
                        <div class="d-flex gap-4 flex-wrap p-3 bg-light rounded border">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="selfRating" id="rXS" value="xs">
                                <label class="form-check-label" for="rXS">Xuất sắc</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="selfRating" id="rTot" value="tot">
                                <label class="form-check-label" for="rTot">Tốt</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="selfRating" id="rKha" value="kha" checked>
                                <label class="form-check-label" for="rKha">Khá</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="selfRating" id="rDat" value="dat">
                                <label class="form-check-label" for="rDat">Đạt</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="selfRating" id="rKDat" value="kdat">
                                <label class="form-check-label" for="rKDat">Chưa đạt</label>
                            </div>
                        </div>

                        <hr class="my-4">
                        <button type="button" onclick="generateReport()" class="btn btn-success btn-lg w-100 fw-bold shadow">
                            <i class="bi bi-file-earmark-word me-2"></i>XUẤT FILE BÁO CÁO (.DOCX)
                        </button>
                    </form>
                </div>
            </div>
            <p class="text-center mt-3 text-muted small">Dữ liệu được xử lý trực tiếp trên trình duyệt, đảm bảo bảo mật.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pizzip@3.2.0/dist/pizzip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>

<script>
    // --- 1. Cấu hình chọn ngày tháng (Flatpickr) ---
    flatpickr("#inputDate", {
        dateFormat: "d/m/Y", // Hiển thị DD/MM/YYYY
        defaultDate: "today", // Mặc định là hôm nay
        locale: "vn",         // Ngôn ngữ tiếng Việt
        allowInput: true      // Cho phép gõ tay
    });

    // --- 2. Quản lý Bảng công việc ---
    window.onload = function() {
        addTaskRow(); // Luôn tạo 1 dòng đầu tiên
    };

    function addTaskRow() {
        const container = document.getElementById('taskList');
        const rowHTML = `
            <div class="task-row row g-2 align-items-center">
                <div class="col-md-1 text-center fw-bold text-primary stt-label">#</div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm task-name" placeholder="Tên công việc">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm task-time" placeholder="Thời gian">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm task-result" placeholder="Kết quả">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm task-note" placeholder="Ghi chú">
                </div>
                <div class="col-md-1 text-center">
                    <i class="bi bi-trash3-fill btn-delete-row" onclick="deleteRow(this)" title="Xóa dòng này"></i>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHTML);
        updateUI(); // Cập nhật lại STT và nút xóa
    }

    // Hàm xóa dòng
    function deleteRow(btn) {
        const row = btn.closest('.task-row');
        row.remove();
        updateUI(); // Cập nhật lại sau khi xóa
    }

    // Hàm cập nhật giao diện (STT và Ẩn/Hiện nút xóa)
    function updateUI() {
        const rows = document.querySelectorAll('.task-row');
        
        rows.forEach((row, index) => {
            // 1. Cập nhật số thứ tự (STT)
            row.querySelector('.stt-label').textContent = `#${index + 1}`;
            
            // 2. Xử lý nút xóa
            const deleteBtn = row.querySelector('.btn-delete-row');
            if (rows.length === 1) {
                // Nếu chỉ còn 1 dòng -> Ẩn nút xóa
                deleteBtn.classList.add('disabled');
            } else {
                // Nếu > 1 dòng -> Hiện nút xóa
                deleteBtn.classList.remove('disabled');
            }
        });
    }

    // --- 3. Các hàm xử lý dữ liệu khác (Giữ nguyên) ---
    function handleEmptyText(textValue) {
        if (textValue && textValue.trim() !== "") return textValue;
        const dots = "................................................................................................................................................................"; 
        return `${dots}\n${dots}\n${dots}`;
    }

    function getRatingMap() {
        const checkedSym = "☑";
        const uncheckedSym = "☐";
        const selected = document.querySelector('input[name="selfRating"]:checked')?.value || "";
        return {
            c_xs:   selected === 'xs'   ? checkedSym : uncheckedSym,
            c_tot:  selected === 'tot'  ? checkedSym : uncheckedSym,
            c_kha:  selected === 'kha'  ? checkedSym : uncheckedSym,
            c_dat:  selected === 'dat'  ? checkedSym : uncheckedSym,
            c_kdat: selected === 'kdat' ? checkedSym : uncheckedSym,
        };
    }

    // --- 4. Hàm Xuất File Word ---
    function generateReport() {
        fetch('./template.docx')
            .then(res => {
                if (res.status !== 200) throw new Error("Không tìm thấy file template.docx!");
                return res.arrayBuffer();
            })
            .then(content => {
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

                // Xử lý Ngày tháng (Lấy từ Flatpickr value dạng DD/MM/YYYY)
                const dateVal = document.getElementById('inputDate').value; 
                const [day, month, year] = dateVal.split("/"); // Tách theo format DD/MM/YYYY

                // Xử lý Bảng
                const taskRows = document.querySelectorAll('.task-row');
                const listData = Array.from(taskRows).map((row, i) => {
                    return {
                        stt: i + 1,
                        ten_cv: row.querySelector('.task-name').value,
                        thoigian_cv: row.querySelector('.task-time').value,
                        ketqua_cv: row.querySelector('.task-result').value,
                        ghichu_CV: row.querySelector('.task-note').value
                    };
                });

                const finalData = {
                    ngay: day, thang: month, nam: year,
                    ho_va_ten: document.getElementById('hoVaTen').value,
                    chuc_vu: document.getElementById('chucVu').value,
                    sdt: document.getElementById('sdt').value,
                    ten_hoat_dong: document.getElementById('tenHoatDong').value,
                    thoigian_hd: document.getElementById('thoiGianHD').value,
                    diadiem_hd: document.getElementById('diaDiemHD').value,
                    ds_viec: listData,
                    khokhan: handleEmptyText(document.getElementById('khoKhan').value),
                    dexuat: handleEmptyText(document.getElementById('deXuat').value),
                    ...getRatingMap()
                };

                doc.render(finalData);
                
                const blob = doc.getZip().generate({
                    type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                // Tên file khi tải về
                const fileNameClean = finalData.ho_va_ten.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                saveAs(blob, `Bao_cao_${fileNameClean}_${day}${month}.docx`);
            })
            .catch(err => {
                alert("Lỗi: " + err.message);
                console.error(err);
            });
    }
</script>

</body>
</html>